---
title: "STA360 Final Project"
author: 
- Martin Lim
- Michael Xue
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(cowplot)
library(pixiedust)
library(kableExtra)
```

```{r echo=FALSE}
data <- read.csv("data.csv")
data <- filter(data, country!="(nu")
```

```{r echo=FALSE}
data <- mutate(data, extraversion = E1 + (6-E2) + E3 + (6-E4) + E5 + (6-E6) + E7 + (6-E8) + E9 + (6-E10))
data <- mutate(data, agreeableness = (6-A1) + A2 + (6-A3) + A4 + (6-A5) + A6 + (6-A7) + A8 + A9 + A10)
data <- mutate(data, conscientiousness = C1 + (6-C2) + C3 + (6-C4) + C5 + (6-C6) + C7 + (6-C8) + C9 + C10)
data <- mutate(data, emotional_stability = (6-N1) + N2 + (6-N3) + N4 + (6-N5) + (6-N6) + (6-N7) + (6-N8) + (6-N9) + 6-N10)
data <- mutate(data, intellect = O1 + (6-O2) + O3 + (6-O4) + O5 + (6-O6) + O7 + O8 + O9 + O10)
```

```{r echo=FALSE, eval=FALSE}
h1 <- ggplot(data, aes(x=extraversion)) +
  geom_histogram(binwidth=2)
h2 <- ggplot(data, aes(x=agreeableness)) +
  geom_histogram(binwidth=2)
h3 <- ggplot(data, aes(x=conscientiousness)) +
  geom_histogram(binwidth=2)
h4 <- ggplot(data, aes(x=emotional_stability)) +
  geom_histogram(binwidth=2)
h5 <- ggplot(data, aes(x=intellect)) +
  geom_histogram(binwidth=2)
title <- ggdraw() + 
  draw_label("Distribution of Scores for Each Factor",
             fontface="bold",
             x = 0,
             hjust=0) +
  theme(plot.margin = margin(0, 0, 0, 7))
p <- plot_grid(h1, h2, h3, h4, h5)
plot_grid(title, p, ncol=1, rel_heights = c(0.1, 1))

quantile(data$extraversion, .8413)
mean(data$extraversion)
```

```{r echo=FALSE, warning=FALSE, results="hide", include=FALSE}
data %>%
  group_by(country) %>%
  count(country) %>%
  arrange(desc(n))

# install.packages("jsonlite", repos="https://cran.rstudio.com/")
library("jsonlite")

json_file <- 'https://datahub.io/JohnSnowLabs/country-and-continent-codes-list/datapackage.json'
json_data <- fromJSON(paste(readLines(json_file), collapse=""))

# get list of all resources:
print(json_data$resources$name)

# print all tabular data(if exists any)
for(i in 1:length(json_data$resources$datahub$type)){
  if(json_data$resources$datahub$type[i]=='derived/csv'){
    path_to_file = json_data$resources$path[i]
    isodata <- read.csv(url(path_to_file))
    isodata <- replace_na(isodata, list(Continent_Code="NA"))
    colnames(isodata)[4] <- "country"
  }
}
```

```{r echo=FALSE}
fulldata <- merge(data, isodata, by=c("country"))
#subset(fulldata, select=-c(Country_Name, Country_Number, Three_Letter_Country_Code, Continent_Name))
fulldata <- subset(fulldata, select=c(Continent_Code, extraversion, agreeableness, conscientiousness, emotional_stability, intellect))
colnames(fulldata)[1] <- "continent"
```


# Introduction
The Big Five personality trait model was developed by various individual researchers. In 1936, Gordon Allport and Henry Odbert formed a list of 4,500 terms relating to personality traits, providing the foundation for other psychologists to start investigating the basic dimensions of personality. Using factor analysis, this list was eventually narrowed down to five key personality traits, which became known as the "Big Five". Each of these five traits actually encompasses a multitude of other traits. For example, extraversion is an aggregate of gregariousness, assertiveness, activity, excitement-seeking, positive emotions, and warmth. Another key aspect of this Big Five model is that it classifies personality traits on a spectrum, rather than into specific categories. The Big Five traits are not associated with any particular personality test, as there are several different ways to measure these traits. Our project focuses on specifically on the Big-Five Factor Markers from the International Personality Item Pool developed by Lewis R. Goldberg. Overall, the Big Five personality trait model can be useful for understanding the distribution of these traits across particular populations of interest, and could thus inform policy decisions, the general political climate, and more. In addition, this analysis will give us insight into whether personality is a product of both nature and nurture, or genetics and environment.

The goal of this project is to use Bayesian analysis to find a posterior distribution that will capture close to the true distribution of scores for the Big Five personality categories at the time of this study, using a weakly informative prior and our dataset. In particular, we hope to distribute our dataset into different classes based on continent in order to see whether there are differences in these posterior distributions potentially due to factors such as location and cultural environment. While it may be hard to gain much insight on the aggregate, we believe such analysis could be useful when focusing on specific populations, such as how the personalities of teenagers in America are changing over time (we can continually update our prior using Bayesian analysis).

Our proposed Bayesian modeling framework will follow the MVN-MVN-IW model as described in class. As such, we hope to use the data and a weakly informative prior in order to generate a posterior that will describe the mean vector for the score on each of the Big Five personality traits and the corresponding covariance matrix. Our weakly informative prior will essentially reflect our hypothesis that there are no differences in personality across continents, and our posterior will give us insight into whether these differences exist, and thus whether environment can play a large role in determining overall trends of personality.

# Data
The data comes from the Open-Source Psychometrics Project, which provides a collection of interactive personality tests. The data was collected in 2012 through an online personality test of the Big-Five Factor Markers from the International Personality Item Pool on the Open-Source Psychometrics Project website. Prior to starting the test, participants were informed that their responses would be recorded and used for research purposes, and consent to record their responses was confirmed after the test. This dataset contains 57 variables: 50 of these variables are the participants' answers to the 50 question Big Five personality test and 7 of these variables are additional demographic information about the participant. The participants answer the 50 questions on a scale of 1 to 5; 1 means that the participant finds the statement "Very Inaccurate", 3 means that the statement is "Neither Accurate Nor Inaccurate", and 5 means that the statement is "Very Accurate"; thus our data is ordinal discrete. The 7 demographic variables that are not factored into the personality test are: race, age, gender, handedness, the participant's country location, how the participant came to the test, and whether English is the participant's native language. The Big Five factors that this 50 question test measures are (1) "extraversion", (2) "agreeableness", (3) "conscientiousness", (4) "emotional stability", and (5) "intellect" (for the purposes of modeling, we will observe this ordering). Each question on the test corresponds to only one of these factors, and each factor is defined by 10 questions. 

The original dataset included 19719 observations, but 378 observations were removed as they were missing the country variables. Given that each observation is the result of just one participant, removing these observations should not have any significant impact on our findings. From the 50 questions, additional variables were created to store the scores received in each of the Big Five factors. Scoring for the factors is computed as follows: each question corresponds to a single factor and is "+keyed" or "-keyed". For "+keyed" items, the response "Very Inaccurate" is assigned a value of 1, "Moderately Inaccurate" a value of 2, "Neither Inaccurate nor Accurate" a 3, "Moderately Accurate" a 4, and "Very Accurate" a value of 5. For "-keyed" items, the response "Very Inaccurate" is assigned a value of 5, "Moderately Inaccurate" a value of 4, "Neither Inaccurate nor Accurate" a 3, "Moderately Accurate" a 2, and "Very Accurate" a value of 1. Once values are calculated for each question, they should be summed to obtain the total score for that factor. Each factor can have a different number of ("+keyed", "-keyed") questions: extraversion (5, 5), agreeableness (6, 4), conscientiousness (6, 4), emotional stability (2, 8), intellect (3, 7). After obtaining a score for each factor on each observation, we found that scores were normally distributed for each factor, with agreeableness and intellect being a little left skewed. 

```{r echo=FALSE}
h1 <- ggplot(data, aes(x=extraversion)) +
  geom_histogram(binwidth=2)
h2 <- ggplot(data, aes(x=agreeableness)) +
  geom_histogram(binwidth=2)
h3 <- ggplot(data, aes(x=conscientiousness)) +
  geom_histogram(binwidth=2)
h4 <- ggplot(data, aes(x=emotional_stability)) +
  geom_histogram(binwidth=2)
h5 <- ggplot(data, aes(x=intellect)) +
  geom_histogram(binwidth=2)
title <- ggdraw() + 
  draw_label("Distribution of Scores for Each Factor",
             x = 0,
             hjust=0) +
  theme(plot.margin = margin(0, 0, 0, 7))
p <- plot_grid(h1, h2, h3, h4, h5)
plot_grid(title, p, ncol=1, rel_heights = c(0.1, 1))
```

In order to perform our Bayesian analysis on each of the continents separately, we must group our data frame by continent by using the country codes. To find the continent codes for each country, we imported a data frame from an outside source mapping country code to the corresponding continent code. We merged the two data frames together and selected only the necessary variables. The continents represented in the final data are North America (NA), Europe (EU), Asia (AS), Oceania (OC), Africa (AF), and South America (SA). 

```{r }
cont_counts <- fulldata %>%
  group_by(continent) %>%
  count(continent) %>%
  arrange(desc(n))
colnames(cont_counts) <- c("Continent", "Count")
dust(cont_counts)
```


# Modeling
```{r }
#### Simulate inverse-Wishart matrix
rinvwish<-function(n,nu0,iS0) 
{
  sL0 <- chol(iS0) 
  S<-array( dim=c( dim(L0),n ) )
  for(i in 1:n) 
  {
    Z <- matrix(rnorm(nu0 * dim(L0)[1]), nu0, dim(iS0)[1]) %*% sL0  
    S[,,i]<- solve(t(Z)%*%Z)
  }     
  S[,,1:n]
}
#### Simulate multivariate normal vector
rmvnorm<-
  function(n,mu,Sigma) {
    p<-length(mu)
    res<-matrix(0,nrow=n,ncol=p)
    if( n>0 & p>0 ) {
      E<-matrix(rnorm(n*p),n,p)
      res<-t(  t(E%*%chol(Sigma)) +c(mu))
    }
    res
  }

mu <- matrix(c(30, 30, 30, 30, 30), nrow=1)
nu <- 5
cov <- matrix(c(146, 0, 0, 0, 0,
                0, 146, 0, 0, 0,
                0, 0, 146, 0, 0,
                0, 0, 0, 146, 0,
                0, 0, 0, 0, 146), nrow=5)
theta <- matrix(c(30, 30, 30, 30), nrow=1)
sigma <- matrix(c(146, 0, 0, 0, 0,
                0, 146, 0, 0, 0,
                0, 0, 146, 0, 0,
                0, 0, 0, 146, 0,
                0, 0, 0, 0, 146), nrow=5)
S <- 10000


```



Our proposed Bayesian model framework is the MVN-MVN-IW (Multivariate Normal - Multivariate Normal - Inverse Wishart) model. This is because we assume our covariance matrix to be unknown, and we see in the EDA that the distribution of the score of each category seems to be roughly normal. Thus, it would make sense to model the vector of scores as a mean vector, and have the covariance matrix represent the variances of the categories on the diagonal and the covariances of the categories on the nondiagonals (it is possible for some of the categories to be correlated with one another, such as intellect and conscientiousness). In this framework, we have two independent priors, $\mathbf \theta$ and $\mathbf\Sigma$. As we want to create a weakly informative prior, we will assume the following:

1. Each continent $i \in (1, 6)$ has the same mean for each of the Big Five personality trait scores. We will set this to be 30, since each category has 10 questions with a presumed average value of 3 (neutral response on a scale of 1-5). Thus, our prior value of $\mathbf \theta = [30, 30, 30, 30, 30]$.
2. The Big Five personality traits are uncorrelated with one another. Thus we will set the off-diagonals of the prior covariance matrix to be 0.
3. Each category's variance for score will be equal. We calculate this via the following. Let $Y$ be a random variable denoting the total score for one of the Big Five personality categories. Since each category's score is determined by ten questions, we can write $Y = X_1 + ... + X_{10}$, where each $X_i \sim U{1,5}$, where $X_i$ represents the score obtained for the $i$'th question, and $U{a,b}$ represents a Discrete Uniform distribution for values $a, a+1, ..., b-1, b$. In other words, we assume each $X_i$ is equally likely to be assigned scores between 1 and 5. Given that the variance of a Discrete Uniform is given by $\frac{n^2 - 1}{12}$, where $n = b - a + 1$, and we assume a weak positive correlation of $Corr(X_i, X_j) = 0.7$ for all $i \neq j$ (since each of these questions are within the same category, we can assume that scores for one question would be positively correlated with those for another), we derive the following:
$$Var(Y) = Var(X_1 + ... + X_{10})\\
= \sum_{i=1}^{10} Var(X_i) + \sum_{i \neq j} Cov(X_i, X_j)\\
= 10 * \frac{5^2-1}{12} + 90 * 0.7 * \frac{5^2-1}{12}\\
= 146$$

Thus, in our prior covariance matrix, we will set the diagonals to be 146.

Now that we have established our priors, our modeling procedure is straightforward. We derive the full conditionals for $\mathbf \theta$ and $\mathbf\Sigma$ and find the following:

We can then run a Gibbs sampler to find out posterior samples.

# Results

# Conclusion





